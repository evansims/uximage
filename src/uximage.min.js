/*!
 * uxImage 2013.07.24
 * http://github.com/evanisms/uximage/

 * Copyright 2013 Evan Sims and other contributors
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:

 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */

function uxImage(){"use strict";if(this.ready=!1,this.speedTestUri="//farm9.staticflickr.com/8519/8629755757_117cdebd73_o.jpg",this.deviceBandwidth=null,this.clientWebPSupport=null,this.lazyLoadDistance=500,this.cachedBreakpointObjects=[],this.cachedLazyObjects=[],this.inputEventCache={inputTicking:!1,viewportScrollTimer:null,viewportResizeTimer:null,lastKnownScrollX:-1,lastKnownScrollY:-1,lastKnownHeight:-1,lastKnownWidth:-1},this.speedTest=function(t){t||(t=function(){});var e=this;this.checkWebP(function(){try{var i=new Image,n=null;i.onload=function(){var i=((new Date).getTime()-n)/1e3;i=i>1?i:1;var o=409600/i/1024,a=o>=150?"high":"low";e.speedTestComplete(a,t)},i.onerror=function(){e.speedTestComplete("low",t)},i.onabort=function(){e.speedTestComplete("low",t)},n=(new Date).getTime(),i.src=e.speedTestUri+"?r="+Math.random(),setTimeout(function(){e.speedTestComplete("low",t)},1e3*(400/150)+350)}catch(o){e.speedTestComplete("low",t)}})},this.speedTestComplete=function(t,e){this.deviceBandwidth||(this.deviceBandwidth=t,e())},this.checkWebP=function(t){if(t||(t=function(){}),null!==this.clientWebPSupport)return t(this.clientWebPSupport),void 0;var e=new Image,i=this;e.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA",e.onload=e.onerror=function(){i.clientWebPSupport=2===e.height&&2===e.width?!0:!1,t(i.clientWebPSupport)}},this.Parse=function(t){t=t||document.body;var e=0,i=t.length;if(i)for(e=0;i>e;e+=1)this.Parse(t[e]);else{var n=t.getElementsByClassName("ux-image");for(i=n.length,e=0;i>e;e+=1)this.Analyze(n[e]);this.onInputEvent("scroll")}},this.Analyze=function(t){var e=[],i=!1;if(e=void 0===typeof t.classList?t.classList:t.className.split(" "),void 0===typeof e.indexOf)-1!=e.indexOf("ondemand")&&(i=!0);else for(var n=0,o=e.length;o>n;n++)if("ondemand"===e[n]){i=!0;break}i&&(t.setAttribute("data-uximage-state","ondemand"),this.cachedLazyObjects.push(t)),this.Transform(t)},this.getElementOffsets=function(t){var e=t.getBoundingClientRect(),i=this.inputEventCache.lastKnownScrollX,n=this.inputEventCache.lastKnownScrollY;return{x:e.left+i,y:e.top+n}},this.scrollProcessor=function(){if(this.cachedLazyObjects.length){var t=this,e=this.inputEventCache.lastKnownScrollY,i=this.inputEventCache.lastKnownHeight,n=[],o=[],a=!1;if(this.deviceBandwidth){for(var s=0,r=t.cachedLazyObjects.length;r>s;s+=1){var d=t.cachedLazyObjects[s];if(void 0!==d)if("ready"===d.getAttribute("data-uximage-state")){var c=t.getElementOffsets(d);e+i>=c.y-t.lazyLoadDistance&&e<=c.y+d.offsetHeight+t.lazyLoadDistance?d.getAttribute("data-loaded")||n.push(d):d.getAttribute("data-loaded")&&o.push(d)}else a=!0;else delete t.cachedLazyObjects[s]}for(s=0,r=n.length;r>s;s+=1)t.transformSource(n[s],function(){n[s].setAttribute("data-loaded","true")});for(s=0,r=o.length;r>s;s+=1)o[s].style.backgroundImage="",o[s].removeAttribute("data-loaded")}(a||!this.deviceBandwidth)&&(this.viewportScrollTimer&&clearTimeout(this.viewportScrollTimer),this.viewportScrollTimer=setTimeout(function(){t.scrollProcessor()},1e3/60))}},this.breakpointApply=function(t,e){if(e||"ready"===t.getAttribute("data-uximage-state")){var i=this,n=t.getBoundingClientRect(),o=parseInt(t.getAttribute("data-breakpoint-high"),10)||null,a=parseInt(t.getAttribute("data-breakpoint"),10)||null;return o||a?(o&&n.width>=o&&"high"==this.deviceBandwidth?i.setSource(t,t.getAttribute("data-src-high")):a&&n.width<=a||"low"==this.deviceBandwidth?i.setSource(t,t.getAttribute("data-src")):t.getAttribute("data-src-medium")?i.setSource(t,t.getAttribute("data-src-medium")):i.setSource(t,t.getAttribute("data-src")),!0):!1}},this.breakpointProcessor=function(){if(this.deviceBandwidth){var t=this,e=t.cachedBreakpointObjects.length;this.inputEventCache.viewportResizeTimer&&(clearTimeout(this.inputEventCache.viewportResizeTimer),this.inputEventCache.viewportResizeTimer=null),e&&(this.inputEventCache.viewportResizeTimer=setTimeout(function(){for(var i=0;e>i;i+=1)t.transformSource(t.cachedBreakpointObjects[i])},1e3/30))}},this.acceptSourceChange=function(t,e){var i=t.style.backgroundImage;return!i.length&&e.length?!0:i==e||i=="url("+e+")"||i=='url("'+e+'")'||i.substring(i.length-e.length-1)==e+")"?!1:!0},this.setSource=function(t,e){this.clientWebPSupport&&t.getAttribute("data-use-webp")&&"webp"!==e.substring(e.lastIndexOf(".")+1)&&(e=e.substring(0,e.lastIndexOf(".")+1)+"webp"),this.acceptSourceChange(t,e)&&(t.style.backgroundImage="url("+e+")")},this.transformSource=function(t,e){if(e=e||function(){},!this.breakpointApply(t)){var i={low:t.getAttribute("data-src"),medium:t.getAttribute("data-src-medium"),high:t.getAttribute("data-src-high")};"low"==this.deviceBandwidth&&i.low?this.setSource(t,i.high):"high"==this.deviceBandwidth&&i.high?this.setSource(t,i.high):i.medium?this.setSource(t,i.medium):i.low&&this.setSource(t,i.low)}e()},this.Transform=function(t,e){if(e||(e=function(){}),this.deviceBandwidth&&"object"==typeof t&&"DIV"==t.tagName&&"ready"!==t.getAttribute("data-uximage-state")){var i=this,n={low:t.getAttribute("data-src"),medium:t.getAttribute("data-src-medium"),high:t.getAttribute("data-src-high")},o={height:t.getAttribute("height")||parseInt(t.style.height,10)||null,width:t.getAttribute("width")||parseInt(t.style.width,10)||null};if(o.width&&o.height){var a=100*(o.height/o.width);t.style.width="",t.style.height="",t.style.paddingBottom=a+"%",t.removeAttribute("width"),t.removeAttribute("height"),"low"==this.deviceBandwidth&&n.low?"ondemand"!==t.getAttribute("data-uximage-state")&&this.transformSource(t):t.getAttribute("data-breakpoint-high")||t.getAttribute("data-breakpoint")?(this.cachedBreakpointObjects.push(t),"ondemand"!==t.getAttribute("data-uximage-state")&&this.breakpointApply(t,!0)):"ondemand"!==t.getAttribute("data-uximage-state")&&this.transformSource(t),t.setAttribute("data-uximage-state","ready"),e()}else{var s=document.createElement("img");document.body.appendChild(s),s.style.display="block",s.style.visibility="hidden";var r=n.low;r||(r=n.medium),r||(r=n.high),s.onload=function(){t.setAttribute("width",this.offsetWidth),t.setAttribute("height",this.offsetHeight),this.parentNode.removeChild(this),i.Transform(t,e)},s.onerror=function(){t.parentNode.removeChild(t),this.parentNode.removeChild(this)},s.src=r}}},this.Loop=function(t){t=t||"scroll","resize"==t?this.breakpointProcessor():this.scrollProcessor(),this.inputEventCache.inputTicking=!1},this.getBrowserState=function(t){switch(t=t||"scroll"){case"resize":this.inputEventCache.lastKnownHeight=void 0!==window.innerHeight?window.innerHeight:(document.documentElement||document.body).clientHeight,this.inputEventCache.lastKnownWidth=void 0!==window.innerWidth?window.innerWidth:(document.documentElement||document.body).clientWidth;break;default:this.inputEventCache.lastKnownScrollX=void 0!==window.pageXOffset?window.pageXOffset:(document.documentElement||document.body.parentNode||document.body).scrollLeft,this.inputEventCache.lastKnownScrollY=void 0!==window.pageYOffset?window.pageYOffset:(document.documentElement||document.body.parentNode||document.body).scrollTop}return!0},this.onInputEvent=function(t){t=t||"scroll",this.inputEventCache.inputTicking||(this.inputEventCache.inputTicking=!0,"resize"==t&&this.getBrowserState("resize"),this.getBrowserState("scroll"),this.requestAnimationFrame(this.Loop(t)))},this.Setup=function(){if(!this.ready){this.ready=!0;var t=document.getElementsByTagName("head")[0],e=document.createElement("style"),i=this;e.innerHTML=[".ux-image {","display: block;","max-width: 100%;","height: auto !important;","position: relative;","background: transparent url(data:image/gif;base64,R0lGODlhAQABAIAAAMz/AAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==) no-repeat center;","-webkit-perspective: 1000;","-moz-perspective: 1000;","-ms-perspective: 1000;","-o-perspective: 1000;","perspective: 1000;","-webkit-backface-visibility: hidden;","-moz-backface-visibility: hidden;","-ms-backface-visibility: hidden;","-o-backface-visibility: hidden;","backface-visibility: hidden;","-webkit-background-size: cover;","-moz-background-size: cover;","-ms-background-size: cover;","-o-background-size: cover;","background-size: cover;","-webkit-transform: translateZ(0);","-moz-transform: translateZ(0);","-ms-transform: translateZ(0);","-o-transform: translateZ(0);","transform: translateZ(0);","}"].join(" "),t.appendChild(e),this.getBrowserState("resize"),this.getBrowserState("scroll"),document.addEventListener("scroll",function(){i.onInputEvent("scroll")},!1),window.addEventListener("resize",function(){i.onInputEvent("resize")},!1)}},this.requestAnimationFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){window.setTimeout(t,16)}},void 0!==window&&void 0!==window.uxImageGlobal)return window.uxImageGlobal;if("complete"===document.readyState||"interactive"===document.readyState)this.Setup();else if(void 0!==window){var t=this;window.addEventListener("onload",function(){t.Setup()},!1),document.addEventListener("DOMContentLoaded",function(){t.Setup()},!1)}return window.uxImageGlobal=this,window.uxImageGlobal}"function"==typeof define&&define("uxImage",[],function(){return new uxImage});