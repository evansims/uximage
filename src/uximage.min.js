
/*!
 * uxImage 2013.05.01
 * http://github.com/evanisms/uximage/

 * Copyright 2013 Evan Sims and other contributors
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:

 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */

function uxImage(){if(this.ready=!1,this.speedTestUri="http://farm9.staticflickr.com/8519/8629755757_117cdebd73_o.jpg",this.deviceRetina=1,this.deviceBandwidth=null,this.clientWebPSupport=null,this.lazyLoadDistance=500,this.cachedBreakpointObjects=[],this.cachedLazyObjects=[],this.throttleProcessor={},this.eventOccured={viewportScrolled:!1,viewportResized:!1},this.speedTest=function(a){a||(a=function(){});var b=this;this.checkWebP(function(){try{var c=new Image,d=null;c.onload=function(){var c=((new Date).getTime()-d)/1e3;c=c>1?c:1;var e=409600/c/1024,f=e>=150?"high":"low";b.speedTestComplete(f,a)},c.onerror=function(){b.speedTestComplete("low",a)},c.onabort=function(){b.speedTestComplete("low",a)},d=(new Date).getTime(),c.src=b.speedTestUri+"?r="+Math.random(),setTimeout(function(){b.speedTestComplete("low",a)},1e3*(400/150)+350)}catch(e){b.speedTestComplete("low",a)}})},this.speedTestComplete=function(a,b){this.deviceBandwidth||(this.deviceBandwidth=a,b())},this.checkWebP=function(a){if(a||(a=function(){}),null!=this.clientWebPSupport)return a(this.clientWebPSupport),void 0;var b=new Image,c=this;b.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA",b.onload=b.onerror=function(){c.clientWebPSupport=2===b.height&&2===b.width?!0:!1,a(c.clientWebPSupport)}},this.Parse=function(a){if(a||(a=document.getElementsByTagName("body")),a.length)for(var b=0,c=a.length;c>b;b+=1)this.Parse(a[b]);else{images=a.getElementsByClassName("ux-image");for(var b=0,c=images.length;c>b;b+=1)this.Analyze(images[b])}this.scrollProcessor(),this.breakpointProcessor()},this.Analyze=function(a){var b=[],c=!1;if(b=void 0===typeof a.classList?a.classList:a.className.split(" "),void 0===typeof b.indexOf)-1!=b.indexOf("ondemand")&&(c=!0);else for(var d=0,e=b.length;e>d;d++)if("ondemand"===b[d]){c=!0;break}c?(a.setAttribute("data-ondemand-state","pre"),this.cachedLazyObjects.push(a)):a.setAttribute("data-loaded","true"),this.Transform(a)},this.scrollProcessor=function(){if(this.cachedLazyObjects.length&&this.deviceBandwidth){var a=this;a.throttleProcessor.scroll&&clearTimeout(a.throttleProcessor.scroll),a.throttleProcessor.scroll=setTimeout(function(){for(var b=document.documentElement,c=document.body,d=b&&b.scrollTop||c&&c.scrollTop||0,f=window.innerHeight||e.clientHeight||g.clientHeight||0,h=0,i=a.cachedLazyObjects.length;i>h;h+=1){var j=a.cachedLazyObjects[h];"ready"===j.getAttribute("data-ondemand-state")&&(d+f>=j.offsetTop-a.lazyLoadDistance&&j.offsetTop+j.offsetHeight+a.lazyLoadDistance>=d?j.getAttribute("data-loaded")||(j.setAttribute("data-scrolled-past","true"),j.setAttribute("data-loaded","true"),a.Transform(j)):j.getAttribute("data-loaded")&&(j.style.backgroundImage="",j.removeAttribute("data-loaded")))}},20)}},this.breakpointApply=function(b){b.getAttribute("data-loaded")&&(b.getAttribute("data-breakpoint-high")||b.getAttribute("data-breakpoint"))&&(b.offsetWidth>=parseInt(b.getAttribute("data-breakpoint-high"))?a.setSource(b,b.getAttribute("data-src-high")):b.offsetWidth>=parseInt(b.getAttribute("data-breakpoint"))?a.setSource(b,b.getAttribute("data-src-medium")):b.offsetWidth<parseInt(b.getAttribute("data-breakpoint"))&&a.setSource(b,b.getAttribute("data-src")))},this.breakpointProcessor=function(){this.throttleProcessor.resize&&clearTimeout(this.throttleProcessor.resize),this.deviceBandwidth||this.breakpointProcessor();var a=this;this.throttleProcessor.resize=setTimeout(function(){for(var b=0,c=a.cachedBreakpointObjects.length;c>b;b+=1)a.breakpointApply(a.cachedBreakpointObjects[b])},150)},this.acceptSourceChange=function(a,b){var c=a.style.backgroundImage;return!c.length&&b.length?!0:RegExp("/(http|https)://(w+:{0,1}w*@)?(S+)(:[0-9]+)? (/|/([w#!:.?+=&%@!-/]))?/").test(b)?c=="url("+b+")"?!1:!0:c.substring(c.length-b.length-1)==b+")"?!1:!0},this.setSource=function(a,b){this.clientWebPSupport&&a.getAttribute("data-use-webp")&&"webp"!==b.substring(b.lastIndexOf(".")+1)&&(b=b.substring(0,b.lastIndexOf(".")+1)+"webp"),this.acceptSourceChange(a,b)&&(a.style.backgroundImage="url("+b+")")},this.Transform=function(a,b){if(b||(b=function(){}),this.deviceBandwidth&&"object"==typeof a&&"DIV"==a.tagName){var c=this,d={low:a.getAttribute("data-src"),medium:a.getAttribute("data-src-medium"),high:a.getAttribute("data-src-high")},e={height:a.getAttribute("height"),width:a.getAttribute("width")};if(e.width&&e.height){var h=100*(e.height/e.width);a.style.paddingBottom=h+"%","pre"==a.getAttribute("data-ondemand-state")?a.setAttribute("data-ondemand-state","ready"):"low"==this.deviceBandwidth&&d.low?this.setSource(a,d.low):a.getAttribute("data-breakpoint-high")||a.getAttribute("data-breakpoint")?(this.cachedBreakpointObjects.push(a),this.breakpointApply(a)):"high"==this.deviceBandwidth&&d.high?this.setSource(a,d.high):d.medium?this.setSource(a,d.medium):d.low&&this.setSource(a,d.low),b()}else{var f=document.createElement("img");document.getElementsByTagName("body")[0].appendChild(f),f.style.display="block",f.style.visibility="hidden";var g=d.low;g||(g=d.medium),g||(g=d.high),f.onload=function(){a.setAttribute("width",this.offsetWidth),a.setAttribute("height",this.offsetHeight),this.parentNode.removeChild(this),c.Transform(a,b)},f.src=g}}},this.getPixelDensity=function(){void 0!==typeof window.devicePixelRatio?this.deviceRetina=window.devicePixelRatio>1:void 0!==typeof window.matchMedia&&(this.deviceRetina=!window.matchMedia("(-moz-device-pixel-ratio:1.0)").matches)},this.Setup=function(){if(!this.ready){this.ready=!0,this.getPixelDensity();var a=document.getElementsByTagName("head")[0],b=document.createElement("style"),c=this;b.innerHTML=".ux-image {max-width: 100%;height: auto !important;position: relative;text-indent: -9999px;background: transparent url(data:image/gif;base64,R0lGODlhAQABAIAAAMz/AAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==) no-repeat center;-moz-background-size: cover;-webkit-background-size: cover;background-size: cover;image-rendering: optimizeQuality;}",a.appendChild(b),setInterval(function(){c.getPixelDensity()},5e3),setInterval(function(){c.viewportScrolled&&(c.viewportScrolled=!1,c.scrollProcessor()),c.viewportResized&&(c.viewportResized=!1,c.breakpointProcessor(),c.scrollProcessor())},50),document.addEventListener("scroll",function(){c.viewportScrolled=!0},!1),window.addEventListener("resize",function(){c.viewportResized=!0},!1)}},void 0!==window&&void 0!==window.uxImageGlobal)return window.uxImageGlobal;if("complete"===document.readyState)this.Setup();else if(void 0!==window){var a=this;window.addEventListener("onload",function(){a.Setup()},!1),document.addEventListener("DOMContentLoaded",function(){a.Setup()},!1)}return window.uxImageGlobal=this,window.uxImageGlobal}"function"==typeof define&&define("uxImage",function(){return new uxImage});
