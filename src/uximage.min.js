/*!
 * uxImage 2013.05.18
 * http://github.com/evanisms/uximage/

 * Copyright 2013 Evan Sims and other contributors
 * Permission is hereby granted, free of charge, to any person obtaining a
 * copy of this software and associated documentation files (the "Software"),
 * to deal in the Software without restriction, including without limitation
 * the rights to use, copy, modify, merge, publish, distribute, sublicense,
 * and/or sell copies of the Software, and to permit persons to whom the
 * Software is furnished to do so, subject to the following conditions:

 * The above copyright notice and this permission notice shall be included
 * in all copies or substantial portions of the Software.

 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS
 * OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL
 * THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
 * FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER
 * DEALINGS IN THE SOFTWARE.
 */

function uxImage(){if(this.ready=!1,this.speedTestUri="//farm9.staticflickr.com/8519/8629755757_117cdebd73_o.jpg",this.deviceRetina=1,this.deviceBandwidth=null,this.clientWebPSupport=null,this.lazyLoadDistance=500,this.cachedBreakpointObjects=[],this.cachedLazyObjects=[],this.throttleProcessor={},this.eventOccured={viewportScrolled:!1,viewportResized:!1},this.speedTest=function(t){t||(t=function(){});var e=this;this.checkWebP(function(){try{var i=new Image,o=null;i.onload=function(){var i=((new Date).getTime()-o)/1e3;i=i>1?i:1;var a=409600/i/1024,s=a>=150?"high":"low";e.speedTestComplete(s,t)},i.onerror=function(){e.speedTestComplete("low",t)},i.onabort=function(){e.speedTestComplete("low",t)},o=(new Date).getTime(),i.src=e.speedTestUri+"?r="+Math.random(),setTimeout(function(){e.speedTestComplete("low",t)},1e3*(400/150)+350)}catch(a){e.speedTestComplete("low",t)}})},this.speedTestComplete=function(t,e){this.deviceBandwidth||(this.deviceBandwidth=t,e())},this.checkWebP=function(t){if(t||(t=function(){}),null!=this.clientWebPSupport)return t(this.clientWebPSupport),void 0;var e=new Image,i=this;e.src="data:image/webp;base64,UklGRjoAAABXRUJQVlA4IC4AAACyAgCdASoCAAIALmk0mk0iIiIiIgBoSygABc6WWgAA/veff/0PP8bA//LwYAAA",e.onload=e.onerror=function(){i.clientWebPSupport=2===e.height&&2===e.width?!0:!1,t(i.clientWebPSupport)}},this.Parse=function(t){if(t||(t=document.body),t.length)for(var e=0,i=t.length;i>e;e+=1)this.Parse(t[e]);else{images=t.getElementsByClassName("ux-image");for(var e=0,i=images.length;i>e;e+=1)this.Analyze(images[e])}},this.Analyze=function(t){var e=[],i=!1;if(e=void 0===typeof t.classList?t.classList:t.className.split(" "),void 0===typeof e.indexOf)-1!=e.indexOf("ondemand")&&(i=!0);else for(var o=0,a=e.length;a>o;o++)if("ondemand"===e[o]){i=!0;break}i?(t.setAttribute("data-ondemand-state","pre"),this.cachedLazyObjects.push(t)):t.setAttribute("data-loaded","true"),this.Transform(t)},this.getElementOffsets=function(t){for(var e=t.offsetLeft,i=t.offsetTop;t.offsetParent&&t!=document.getElementsByTagName("body")[0];)e+=t.offsetParent.offsetLeft,i+=t.offsetParent.offsetTop,t=t.offsetParent;return{x:e,y:i}},this.scrollProcessor=function(){if(this.cachedLazyObjects.length&&this.deviceBandwidth){var t=this;t.throttleProcessor.scroll&&clearTimeout(t.throttleProcessor.scroll),t.throttleProcessor.scroll=setTimeout(function(){for(var i=document.documentElement,o=document.body,a=i&&i.scrollTop||o&&o.scrollTop||0,s=window.innerHeight||e.clientHeight||g.clientHeight||0,n=0,r=t.cachedLazyObjects.length;r>n;n+=1){var d=t.cachedLazyObjects[n];"ready"===d.getAttribute("data-ondemand-state")&&(imagePosition=t.getElementOffsets(d),a+s>=imagePosition.y-t.lazyLoadDistance&&a<=imagePosition.y+d.offsetHeight+t.lazyLoadDistance?d.getAttribute("data-loaded")||(d.setAttribute("data-loaded","true"),t.Transform(d)):d.getAttribute("data-loaded")&&(d.style.backgroundImage="",d.removeAttribute("data-loaded")))}},20)}},this.breakpointApply=function(t){if(t.getAttribute("data-loaded")){var e=this;(t.getAttribute("data-breakpoint-high")||t.getAttribute("data-breakpoint"))&&(t.offsetWidth>=parseInt(t.getAttribute("data-breakpoint-high"))?e.setSource(t,t.getAttribute("data-src-high")):t.offsetWidth>=parseInt(t.getAttribute("data-breakpoint"))?e.setSource(t,t.getAttribute("data-src-medium")):t.offsetWidth<parseInt(t.getAttribute("data-breakpoint"))&&e.setSource(t,t.getAttribute("data-src")))}},this.breakpointProcessor=function(){this.throttleProcessor.resize&&clearTimeout(this.throttleProcessor.resize),this.deviceBandwidth||this.breakpointProcessor();var t=this;this.throttleProcessor.resize=setTimeout(function(){for(var e=0,i=t.cachedBreakpointObjects.length;i>e;e+=1)t.breakpointApply(t.cachedBreakpointObjects[e])},150)},this.acceptSourceChange=function(t,e){var i=t.style.backgroundImage;return!i.length&&e.length?!0:new RegExp("/(http|https)://(w+:{0,1}w*@)?(S+)(:[0-9]+)? (/|/([w#!:.?+=&%@!-/]))?/").test(e)?i=="url("+e+")"?!1:!0:i.substring(i.length-e.length-1)==e+")"?!1:!0},this.setSource=function(t,e){this.clientWebPSupport&&t.getAttribute("data-use-webp")&&"webp"!==e.substring(e.lastIndexOf(".")+1)&&(e=e.substring(0,e.lastIndexOf(".")+1)+"webp"),this.acceptSourceChange(t,e)&&(t.style.backgroundImage="url("+e+")")},this.Transform=function(t,e){if(e||(e=function(){}),this.deviceBandwidth&&"object"==typeof t&&"DIV"==t.tagName){var i=this,o={low:t.getAttribute("data-src"),medium:t.getAttribute("data-src-medium"),high:t.getAttribute("data-src-high")},a={height:t.getAttribute("height"),width:t.getAttribute("width")};if(a.width&&a.height){var s=100*(a.height/a.width);t.style.paddingBottom=s+"%","pre"==t.getAttribute("data-ondemand-state")?t.setAttribute("data-ondemand-state","ready"):"low"==this.deviceBandwidth&&o.low?this.setSource(t,o.low):t.getAttribute("data-breakpoint-high")||t.getAttribute("data-breakpoint")?(this.cachedBreakpointObjects.push(t),this.breakpointApply(t)):"high"==this.deviceBandwidth&&o.high?this.setSource(t,o.high):o.medium?this.setSource(t,o.medium):o.low&&this.setSource(t,o.low),this.viewportScrolled=!0,this.viewportResized=!0,e()}else{var n=document.createElement("img");document.body.appendChild(n),n.style.display="block",n.style.visibility="hidden";var r=o.low;r||(r=o.medium),r||(r=o.high),n.onload=function(){t.setAttribute("width",this.offsetWidth),t.setAttribute("height",this.offsetHeight),this.parentNode.removeChild(this),i.Transform(t,e)},n.src=r}}},this.getPixelDensity=function(){void 0!==typeof window.devicePixelRatio?this.deviceRetina=window.devicePixelRatio>1:void 0!==typeof window.matchMedia&&(this.deviceRetina=!window.matchMedia("(-moz-device-pixel-ratio:1.0)").matches)},this.Setup=function(){if(!this.ready){this.ready=!0,this.getPixelDensity();var t=document.getElementsByTagName("head")[0],e=document.createElement("style"),i=this;e.innerHTML=".ux-image {max-width: 100%;height: auto !important;position: relative;text-indent: -9999px;background: transparent url(data:image/gif;base64,R0lGODlhAQABAIAAAMz/AAAAACH5BAEAAAAALAAAAAABAAEAAAICRAEAOw==) no-repeat center;-moz-background-size: cover;-webkit-background-size: cover;background-size: cover;image-rendering: optimizeQuality;}",t.appendChild(e),setInterval(function(){i.getPixelDensity()},5e3),setInterval(function(){i.viewportScrolled&&(i.viewportScrolled=!1,i.scrollProcessor()),i.viewportResized&&(i.viewportResized=!1,i.breakpointProcessor(),i.scrollProcessor())},50),document.addEventListener("scroll",function(){i.viewportScrolled=!0},!1),window.addEventListener("resize",function(){i.viewportResized=!0},!1)}},void 0!==window&&void 0!==window.uxImageGlobal)return window.uxImageGlobal;if("complete"===document.readyState||"interactive"===document.readyState)this.Setup();else if(void 0!==window){var t=this;window.addEventListener("onload",function(){t.Setup()},!1),document.addEventListener("DOMContentLoaded",function(){t.Setup()},!1)}return window.uxImageGlobal=this,window.uxImageGlobal}"function"==typeof define&&define("uxImage",[],function(){return new uxImage});